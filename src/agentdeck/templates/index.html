{% extends "base.html" %}

{% block content %}
<div x-data="codeServer()" class="flex flex-col fixed inset-x-0 top-0" style="height: calc(var(--app-height, 100vh))" data-sessions='{{ sessions | tojson }}' data-session-refresh-ms="{{ session_refresh_ms }}" data-snippets='{{ prompt_snippets | tojson }}' data-public-url="{{ public_url }}">
    <!-- Top navbar -->
    <div class="navbar bg-base-100 shadow-lg px-4">
        <div class="flex-1 flex items-center gap-1">
            <button class="btn btn-ghost btn-sm btn-square"
                    @click="location.reload()"
                    title="Refresh page">
                <svg class="w-5 h-5" fill="none"
                     stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2.5"
                          d="M4 4v5h5M20 20v-5h-5"/>
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2.5"
                          d="M20.49 9A9 9 0 005.64 5.64L4 9m16 6l-1.64 3.36A9 9 0 014.51 15"/>
                </svg>
            </button>
            <span class="text-sm font-bold truncate"
                  x-text="activeSession
                    ? 'Session: ' + (activeSession.length > 30
                      ? activeSession.slice(0, 30) + '…'
                      : activeSession)
                    : 'Remote Agent'"></span>
        </div>
        <div class="flex-none gap-2">
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-sm btn-ghost">
                    Sessions
                    <span class="badge badge-sm badge-primary" x-text="sessionCount"></span>
                </div>
                <div tabindex="0" class="dropdown-content z-50 menu p-4 shadow-xl bg-base-200 rounded-box w-80 mt-2">
                    <div id="session-list">
                        <!-- Active sessions -->
                        <template x-for="s in aliveSessions" :key="s.session_id">
                        <div class="flex items-center justify-between p-2 rounded hover:bg-base-300 mb-1"
                             :class="{'bg-primary/15': s.session_id === activeSession}">
                            <span class="w-2 h-2 rounded-full bg-success mr-2 flex-shrink-0"></span>
                            <button class="btn btn-xs btn-ghost flex-1 text-left truncate"
                                    :class="{'btn-active': s.session_id === activeSession}"
                                    @click="switchSession(s.session_id); document.activeElement.blur()">
                                <span x-text="s.session_id"></span>
                            </button>
                            <button class="btn btn-xs btn-error btn-outline"
                                    @mousedown.prevent
                                    @click.stop="killSession(s.session_id)">
                                &times;
                            </button>
                        </div>
                        </template>

                        <!-- History divider (only if dead sessions exist) -->
                        <template x-if="deadSessions.length > 0">
                            <div class="divider my-1 text-xs text-base-content/50">History</div>
                        </template>

                        <!-- Dead sessions -->
                        <template x-for="s in deadSessions" :key="s.session_id">
                        <div class="flex items-center justify-between p-2 rounded hover:bg-base-300 mb-1"
                             :class="{'bg-primary/15': s.session_id === activeSession}">
                            <span class="w-2 h-2 rounded-full bg-base-content/30 mr-2 flex-shrink-0"></span>
                            <button class="btn btn-xs btn-ghost flex-1 text-left truncate"
                                    :class="{'btn-active': s.session_id === activeSession}"
                                    @click="switchSession(s.session_id); document.activeElement.blur()">
                                <span x-text="s.session_id"></span>
                                <span class="text-xs text-base-content/40 font-normal ml-1"
                                      x-text="timeAgo(s.ended_at)"></span>
                            </button>
                            <button class="btn btn-xs btn-ghost btn-square text-base-content/40 flex-shrink-0"
                                    @mousedown.prevent
                                    @click.stop="removeDeadSession(s.session_id)"
                                    title="Remove from history">
                                &times;
                            </button>
                        </div>
                        </template>
                    </div>
                    <div class="divider my-1"></div>
                    <form @submit.prevent="createSession(); document.activeElement.blur()">
                        <fieldset>
                            <label class="label">
                                <span class="label-text">Work directory</span>
                            </label>
                            <input type="text"
                                   x-model="newWorkingDir"
                                   list="recent-dirs"
                                   class="input input-sm w-full mb-2">
                            <datalist id="recent-dirs">
                                <template x-for="dir in recentDirs" :key="dir">
                                    <option :value="dir"></option>
                                </template>
                            </datalist>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="label-text flex-shrink-0">Agent</span>
                                <select x-model="newAgentType"
                                        class="select select-sm flex-1">
                                    <option value="claude">Claude</option>
                                    <option value="codex">Codex</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="label-text flex-shrink-0">Name</span>
                                <span class="text-xs text-base-content/70">agent-</span>
                                <input type="text"
                                       x-model="newTitle"
                                       class="input input-sm flex-1">
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary w-full">
                                New Session
                            </button>
                        </fieldset>
                    </form>
                    <div class="text-[0.6rem] text-base-content/30 text-right mt-1"
                         x-text="window.innerWidth + '×' + window.innerHeight"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content area -->
    <div class="flex-1 overflow-hidden mx-4 mt-2 relative">
        <!-- Terminal view -->
        <div class="h-full overflow-auto relative"
             style="overscroll-behavior-y: contain"
             x-ref="terminalScroll">
            <!-- Sticky scroll timestamp badge -->
            <div x-show="scrollTimestamp"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 -translate-y-1"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="sticky top-0 z-10 mx-auto w-fit px-3 py-0.5
                        rounded-b-lg bg-base-300/80 backdrop-blur
                        text-base-content/50 text-[0.65rem] font-mono
                        select-none pointer-events-none"
                 x-text="scrollTimestamp"></div>
            <!-- Sentinel outside x-if so it always exists for IntersectionObserver -->
            <div id="history-sentinel" class="history-sentinel"></div>
            <template x-if="activeSession">
                <div>
                    <div x-show="historyLoading" class="text-center text-base-content/40 text-xs py-2">
                        Loading history...
                    </div>
                    <template x-for="(chunk, i) in historyChunks" :key="chunk.ts">
                        <pre class="terminal-pre history-chunk p-3 bg-base-100 text-xs leading-relaxed whitespace-pre-wrap"
                             :data-ts="chunk.ts"
                             x-html="chunk.content"></pre>
                    </template>

                    <!-- Live zone (only for alive sessions) -->
                    <template x-if="isActiveSessionAlive">
                        <div id="terminal-container"
                             :hx-get="'/api/v1/sessions/' + activeSession + '/output?force=true'"
                             hx-trigger="load, every 800ms, poll"
                             hx-swap="innerHTML"
                             x-init="$nextTick(() => htmx.process($el))">
                            <pre id="terminal-output" class="terminal-pre p-3 bg-base-100 rounded-lg text-xs leading-relaxed whitespace-pre overflow-x-auto"></pre>
                        </div>
                    </template>
                    <div id="ui-state-data" style="display:none"></div>

                </div>
            </template>
            <div x-show="!activeSession" class="flex items-center justify-center h-full">
                <div class="text-center text-base-content/50">
                    <p class="text-lg mb-2">No active session</p>
                    <p class="text-sm">Create a new session to get started</p>
                </div>
            </div>
        </div>
        <!-- Floating nav for dead sessions -->
        <div x-show="activeSession && !isActiveSessionAlive"
             class="absolute bottom-2 left-1/2 -translate-x-1/2
                    md:left-5/6 z-10
                    flex gap-1 px-2 py-1 rounded-full
                    bg-base-300/80 backdrop-blur shadow-lg">
            <button class="btn btn-md btn-square btn-ghost"
                    @click="jumpToPrevPrompt()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 19V5"/><path d="M5 12l7-7 7 7"/>
                </svg>
            </button>
            <button class="btn btn-md btn-square btn-ghost"
                    @click="jumpToNextPrompt()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/>
                </svg>
            </button>
            <button class="btn btn-md btn-square btn-ghost"
                    @click="_pinned=true; $refs.terminalScroll.scrollTop=$refs.terminalScroll.scrollHeight">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Input bar (only for alive sessions) -->
    <div class="px-4 py-2 bg-base-200"
         x-show="isActiveSessionAlive">
        <!-- Shortcut buttons -->
        <div class="flex gap-1 mb-1">
            <div class="flex gap-1 overflow-x-auto">
                <!-- Shared: visible in all layouts except selection -->
                <button x-show="buttonLayout !== 'selection'"
                        class="btn btn-sm btn-square btn-warning"
                        @click="_slashNav = false; sendShortcut('stop')"
                        :disabled="!connected"
                        title="Escape">
                    <span class="text-lg leading-none">⎋</span>
                </button>
                <button x-show="buttonLayout !== 'selection'"
                        class="btn btn-sm btn-square btn-outline"
                        @click="buttonLayout === 'scroll' ? jumpToPrevPrompt() : sendShortcut('up')"
                        :disabled="!connected">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 19V5"/><path d="M5 12l7-7 7 7"/>
                    </svg>
                </button>
                <button x-show="buttonLayout !== 'selection'"
                        class="btn btn-sm btn-square btn-outline"
                        @click="buttonLayout === 'scroll' ? jumpToNextPrompt() : sendShortcut('down')"
                        :disabled="!connected">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/>
                    </svg>
                </button>

                <!-- Selection layout: numbered picks + dismiss -->
                <template x-for="item in selectionItems.filter(i => !i.is_freeform)" :key="item.number">
                    <button x-show="buttonLayout === 'selection'"
                            class="btn btn-sm btn-outline"
                            @click="selectOption(item.number)"
                            :disabled="!connected"
                            x-text="item.number">
                    </button>
                </template>
                <button x-show="buttonLayout === 'selection'"
                        class="btn btn-sm btn-ghost"
                        @click="uiState = 'working'; _selectionDismissed = true"
                        title="Dismiss selection">
                    ...
                </button>

                <!-- Slash layout: arrow nav + enter -->
                <button x-show="buttonLayout === 'slash'"
                        class="btn btn-sm btn-square btn-outline"
                        @click="sendShortcut('left')"
                        :disabled="!connected">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5"/><path d="M12 5l-7 7 7 7"/>
                    </svg>
                </button>
                <button x-show="buttonLayout === 'slash'"
                        class="btn btn-sm btn-square btn-outline"
                        @click="sendShortcut('right')"
                        :disabled="!connected">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14"/><path d="M12 5l7 7-7 7"/>
                    </svg>
                </button>
                <button x-show="buttonLayout === 'slash'"
                        class="btn btn-sm btn-square btn-outline"
                        @click="sendShortcut('enter')"
                        :disabled="!connected"
                        title="Enter">
                    <svg class="w-5 h-5 -translate-y-px" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 7v10H6"/><path d="M10 13l-5 4 5 4"/>
                    </svg>
                </button>

                <!-- Normal layout -->
                <button x-show="buttonLayout === 'normal'"
                        class="btn btn-sm btn-square btn-outline"
                        @click="sendShortcut('enter')"
                        :disabled="!connected"
                        title="Enter">
                    <svg class="w-5 h-5 -translate-y-px" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 7v10H6"/><path d="M10 13l-5 4 5 4"/>
                    </svg>
                </button>
                <button x-show="buttonLayout === 'normal'"
                        class="btn btn-sm btn-square btn-outline"
                        @click="sendShortcut('tab')"
                        :disabled="!connected"
                        title="Shift-Tab">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 12h11"/><path d="M11 6l6 6-6 6"/><path d="M20 5v14"/>
                    </svg>
                </button>
                <button x-show="buttonLayout === 'normal'"
                        class="btn btn-sm btn-square btn-error ml-auto"
                        @click="sendShortcut('cancel')"
                        :disabled="!connected"
                        title="Ctrl-C">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <rect x="4" y="4" width="16" height="16" rx="2"/>
                    </svg>
                </button>

                <!-- Scroll layout (left/right hidden, kept for future use) -->
                <button x-show="false"
                        @click="jumpToPrevPrompt()"
                        class="btn btn-sm btn-square btn-outline"
                        title="Previous prompt">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5"/><path d="M12 5l-7 7 7 7"/>
                    </svg>
                </button>
                <button x-show="false"
                        @click="jumpToNextPrompt()"
                        class="btn btn-sm btn-square btn-outline"
                        title="Next prompt">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14"/><path d="M12 5l7 7-7 7"/>
                    </svg>
                </button>
                <button x-show="buttonLayout === 'scroll'"
                        @click="_pinned=true; $refs.terminalScroll.scrollTop=$refs.terminalScroll.scrollHeight"
                        class="btn btn-sm btn-square btn-outline ml-auto"
                        title="Jump to bottom">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </button>
            </div>
            <button class="btn btn-sm btn-square btn-ghost flex-shrink-0"
                    :disabled="!connected"
                    @click="$refs.imageInput.click()"
                    title="Attach image">
                <svg class="w-5 h-5" fill="none"
                     stroke="currentColor" viewBox="0 0 24 24"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     stroke-width="2.5">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                </svg>
            </button>
            <div class="relative flex-shrink-0">
                <button class="btn btn-sm btn-square btn-ghost"
                        :disabled="!connected"
                        @mousedown.prevent="attachPointerDown()"
                        @mouseup="attachPointerUp()"
                        @touchstart.prevent="attachPointerDown()"
                        @touchend="attachPointerUp()"
                        @contextmenu.prevent
                        title="Slash commands (hold)">
                    <span class="text-xl font-bold">/</span>
                </button>
                <div x-show="_attachPopoverOpen"
                     x-transition:enter="transition ease-out duration-150"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-100"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     @click.outside="_attachPopoverOpen = false"
                     class="absolute bottom-full right-0 mb-2 z-50
                            menu p-2 shadow-xl bg-base-200
                            rounded-box min-w-48 text-base">
                    <template x-for="cmd in slashCommands"
                              :key="cmd.text">
                        <li><a @click="_attachPopoverOpen = false;
                                      sendSlashCommand(cmd)"
                               x-text="cmd.text"></a></li>
                    </template>
                    <template x-if="promptSnippets.length">
                        <li class="border-t border-base-content/10 mt-1 pt-1"></li>
                    </template>
                    <template x-for="snip in promptSnippets"
                              :key="snip.label">
                        <li><a @click="_attachPopoverOpen = false;
                                      insertSnippet(snip.text)"
                               x-text="snip.label"></a></li>
                    </template>
                    <li x-show="notificationsSupported"
                        class="border-t border-base-content/10 mt-1 pt-1">
                        <a @click="_attachPopoverOpen = false;
                                  toggleNotification()">
                            <span x-text="isSessionNotified
                                ? 'Disable notifications'
                                : 'Enable notifications'"></span>
                        </a>
                    </li>
                    <li class="border-t border-base-content/10 mt-1 pt-1">
                        <a @click="_attachPopoverOpen = false;
                                  debugSession()">
                            Debug this screen
                        </a>
                    </li>
                </div>
            </div>
        </div>
        <input type="file"
               accept="image/png,image/jpeg"
               style="display:none"
               x-ref="imageInput"
               @change="pasteImage($event)">

        <!-- Text input -->
        <div class="flex gap-2 items-end">
            <textarea x-model="inputText"
                      placeholder="Type a message or command..."
                      class="textarea flex-1 resize-none leading-normal text-lg"
                      rows="2"
                      :disabled="!connected"
                      x-ref="messageInput"
                      @keydown.enter="if(!$event.shiftKey&&matchMedia('(hover:hover)').matches){$event.preventDefault();sendMessage()}"
                      style="font-family: system-ui, -apple-system, sans-serif; min-height: 3.5rem; max-height: 8lh"
                      @input="$el.style.height='auto';$el.style.height=$el.scrollHeight+'px'"></textarea>
            <button type="button"
                    class="btn btn-primary btn-sm btn-square"
                    :disabled="!connected || !inputText.trim()"
                    @click="sendMessage()">
                <svg class="w-5 h-5" fill="none"
                     stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2.5"
                          d="M5 12h14m-7-7l7 7-7 7"/>
                </svg>
            </button>
        </div>
        <div x-show="!connected" class="text-warning text-xs mt-1">
            Disconnected - reconnecting...
        </div>
    </div>
    <!-- Debug modal -->
    <dialog class="modal" :class="{'modal-open': showDebugModal}">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-2">Report an issue</h3>
            <textarea x-model="debugDescription"
                      x-ref="debugInput"
                      class="textarea w-full"
                      rows="5"
                      placeholder="What went wrong?"></textarea>
            <div class="modal-action">
                <button class="btn btn-ghost"
                        @click="showDebugModal = false">Cancel</button>
                <button class="btn btn-primary"
                        :disabled="!debugDescription.trim()"
                        @click="submitDebug()">Debug</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"
              @click="showDebugModal = false"></form>
    </dialog>
</div>
{% endblock %}
