{% extends "base.html" %}

{% block content %}
<div x-data="codeServer()" class="flex flex-col h-screen" data-sessions='{{ sessions | tojson }}' data-session-refresh-ms="{{ session_refresh_ms }}">
    <!-- Top navbar -->
    <div class="navbar bg-base-100 shadow-lg px-4">
        <div class="flex-1">
            <span class="text-lg font-bold"
                  x-text="activeSession
                    ? (isActiveSessionAlive
                      ? 'Remote agent session: ' + activeSession
                      : 'Conversation history with ' + activeSession
                        + (activeSessionInfo?.ended_at
                          ? ' (' + formatEndedAt(activeSessionInfo.ended_at) + ')'
                          : ''))
                    : 'Remote Agent'"></span>
        </div>
        <div class="flex-none gap-2">
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-sm btn-ghost">
                    Sessions
                    <span class="badge badge-sm badge-primary" x-text="sessionCount"></span>
                </div>
                <div tabindex="0" class="dropdown-content z-50 menu p-4 shadow-xl bg-base-200 rounded-box w-80 mt-2">
                    <div id="session-list">
                        <!-- Active sessions -->
                        <template x-for="s in aliveSessions" :key="s.session_id">
                        <div class="flex items-center justify-between p-2 rounded hover:bg-base-300 mb-1"
                             :class="{'bg-primary/15': s.session_id === activeSession}">
                            <span class="w-2 h-2 rounded-full bg-success mr-2 flex-shrink-0"></span>
                            <button class="btn btn-xs btn-ghost flex-1 text-left truncate"
                                    :class="{'btn-active': s.session_id === activeSession}"
                                    @click="switchSession(s.session_id); document.activeElement.blur()">
                                <span x-text="s.session_id"></span>
                            </button>
                            <button class="btn btn-xs btn-error btn-outline"
                                    @mousedown.prevent
                                    @click.stop="killSession(s.session_id)">
                                &times;
                            </button>
                        </div>
                        </template>

                        <!-- History divider (only if dead sessions exist) -->
                        <template x-if="deadSessions.length > 0">
                            <div class="divider my-1 text-xs text-base-content/50">History</div>
                        </template>

                        <!-- Dead sessions -->
                        <template x-for="s in deadSessions" :key="s.session_id">
                        <div class="flex items-center justify-between p-2 rounded hover:bg-base-300 mb-1"
                             :class="{'bg-primary/15': s.session_id === activeSession}">
                            <span class="w-2 h-2 rounded-full bg-base-content/30 mr-2 flex-shrink-0"></span>
                            <button class="btn btn-xs btn-ghost flex-1 text-left truncate"
                                    :class="{'btn-active': s.session_id === activeSession}"
                                    @click="switchSession(s.session_id); document.activeElement.blur()">
                                <span x-text="s.session_id"></span>
                                <span class="text-xs text-base-content/40 font-normal ml-1"
                                      x-text="timeAgo(s.ended_at)"></span>
                            </button>
                            <button class="btn btn-xs btn-ghost btn-square text-base-content/40 flex-shrink-0"
                                    @mousedown.prevent
                                    @click.stop="removeDeadSession(s.session_id)"
                                    title="Remove from history">
                                &times;
                            </button>
                        </div>
                        </template>
                    </div>
                    <div class="divider my-1"></div>
                    <form @submit.prevent="createSession(); document.activeElement.blur()">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Work directory</span>
                            </label>
                            <input type="text"
                                   x-model="newWorkingDir"
                                   list="recent-dirs"
                                   class="input input-sm input-bordered w-full mb-2">
                            <datalist id="recent-dirs">
                                <template x-for="dir in recentDirs" :key="dir">
                                    <option :value="dir"></option>
                                </template>
                            </datalist>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="label-text flex-shrink-0">Agent</span>
                                <select x-model="newAgentType"
                                        class="select select-sm select-bordered flex-1">
                                    <option value="claude">Claude</option>
                                    <option value="codex">Codex</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="label-text flex-shrink-0">Name</span>
                                <span class="text-xs text-base-content/70">agent-</span>
                                <input type="text"
                                       x-model="newTitle"
                                       class="input input-sm input-bordered flex-1">
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary w-full">
                                New Session
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content area -->
    <div class="flex-1 overflow-hidden mx-4 mt-2">
        <!-- Terminal view -->
        <div class="h-full overflow-auto relative"
             x-ref="terminalScroll">
            <!-- Sticky timestamp badge -->
            <div x-show="scrollTimestamp"
                 x-text="scrollTimestamp"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 -translate-y-1"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="sticky top-0 z-10 mx-auto w-fit px-3 py-0.5 rounded-b-lg bg-base-300/80 backdrop-blur text-base-content/50 text-[0.65rem] font-mono select-none pointer-events-none"></div>
            <template x-if="activeSession">
                <div>
                    <!-- History zone (scrollback from DB) -->
                    <div id="history-sentinel" class="history-sentinel"></div>
                    <div x-show="historyLoading" class="text-center text-base-content/40 text-xs py-2">
                        Loading history...
                    </div>
                    <template x-for="(chunk, i) in historyChunks" :key="chunk.ts">
                        <pre class="terminal-pre history-chunk p-3 bg-base-100 text-xs leading-relaxed whitespace-pre-wrap"
                             :data-ts="chunk.ts"
                             x-html="chunk.content"></pre>
                    </template>

                    <!-- Live zone (only for alive sessions) -->
                    <template x-if="isActiveSessionAlive">
                        <div id="terminal-container"
                             :hx-get="'/api/v1/sessions/' + activeSession + '/output?force=true'"
                             hx-trigger="load, every 800ms, poll"
                             hx-swap="innerHTML"
                             x-init="$nextTick(() => htmx.process($el))">
                            <pre id="terminal-output" class="terminal-pre p-3 bg-base-100 rounded-lg text-xs leading-relaxed whitespace-pre overflow-x-auto"></pre>
                        </div>
                    </template>
                    <div id="ui-state-data" style="display:none"></div>

                    <!-- Dead session banner -->
                    <div x-show="!isActiveSessionAlive"
                         class="text-center text-base-content/50 py-8 border-t border-base-content/10">
                        Session ended
                    </div>
                </div>
            </template>
            <div x-show="!activeSession" class="flex items-center justify-center h-full">
                <div class="text-center text-base-content/50">
                    <p class="text-lg mb-2">No active session</p>
                    <p class="text-sm">Create a new session to get started</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Selection overlay (only for alive sessions) -->
    <div class="p-2 bg-base-300 border-t border-base-content/10"
         x-show="isActiveSessionAlive && uiState === 'selection'"
         x-transition>
        <div class="flex gap-1 mb-1 overflow-x-auto">
            <template x-for="item in selectionItems.filter(i => !i.is_freeform)" :key="item.number">
                <button class="btn btn-sm btn-outline"
                        @click="selectOption(item.number)"
                        :disabled="!connected"
                        x-text="item.number">
                </button>
            </template>
            <button class="btn btn-sm btn-ghost whitespace-nowrap"
                    @click="uiState = 'working'; _selectionDismissed = true"
                    title="Switch to manual input">
                ...
            </button>
        </div>
        <template x-if="selectionItems.some(i => i.is_freeform)">
            <form class="flex gap-2" @submit.prevent="selectOption(selectionItems.find(i => i.is_freeform).number, true)">
                <input type="text"
                       x-model="freeformText"
                       placeholder="Type something..."
                       class="input input-sm input-bordered flex-1"
                       :disabled="!connected">
                <button type="submit" class="btn btn-sm btn-primary"
                        :disabled="!connected || !freeformText.trim()">
                    Send
                </button>
            </form>
        </template>
    </div>

    <!-- Input bar (only for alive sessions) -->
    <div class="p-4 bg-base-200"
         x-show="isActiveSessionAlive && uiState !== 'selection'">
        <!-- Shortcut buttons -->
        <div class="flex gap-1 mb-2">
            <div class="flex gap-1 overflow-x-auto">
                <button class="btn btn-sm btn-square btn-warning"
                        @click="sendShortcut('stop')"
                        :disabled="!connected"
                        title="Escape">
                    <span class="text-[0.6rem] font-bold leading-none">ESC</span>
                </button>
                <button class="btn btn-sm btn-square btn-outline"
                        @click="sendShortcut('up')"
                        :disabled="!connected">&#x2191;</button>
                <button class="btn btn-sm btn-square btn-outline"
                        @click="sendShortcut('down')"
                        :disabled="!connected">&#x2193;</button>
                <button class="btn btn-sm btn-square btn-primary"
                        @click="sendShortcut('enter')"
                        :disabled="!connected"
                        title="Enter">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 7v10H6"/><path d="M10 13l-5 4 5 4"/>
                    </svg>
                </button>
                <button class="btn btn-sm btn-square btn-secondary"
                        @click="sendShortcut('tab')"
                        :disabled="!connected"
                        title="Shift-Tab">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 12h11"/><path d="M11 6l6 6-6 6"/><path d="M20 5v14"/>
                    </svg>
                </button>
                <button class="btn btn-sm btn-square btn-error ml-auto"
                        @click="sendShortcut('cancel')"
                        :disabled="!connected"
                        title="Ctrl-C">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <rect x="4" y="4" width="16" height="16" rx="2"/>
                    </svg>
                </button>
            </div>
            <div class="dropdown dropdown-top">
                <button tabindex="0"
                        class="btn btn-sm btn-square btn-ghost"
                        :disabled="!connected"
                        title="Slash commands">
                    <span class="text-lg font-bold">/</span>
                </button>
                <ul tabindex="0"
                    class="dropdown-content z-50 menu p-2 shadow-xl bg-base-200 rounded-box mb-2">
                    <template x-for="cmd in slashCommands" :key="cmd.text">
                        <li><a @click="sendSlashCommand(cmd)" x-text="cmd.text"></a></li>
                    </template>
                </ul>
            </div>
            <button class="btn btn-sm btn-square btn-ghost flex-shrink-0"
                    @click="debugSession()"
                    :disabled="!connected"
                    title="Debug session">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 2l1.88 1.88M14.12 3.88L16 2"/>
                    <path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/>
                    <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/>
                    <path d="M12 20v-9"/>
                    <path d="M6.53 9C4.6 8.8 3 7.1 3 5"/>
                    <path d="M6 13H2"/>
                    <path d="M3 21c0-2.1 1.7-3.9 3.8-4"/>
                    <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/>
                    <path d="M22 13h-4"/>
                    <path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/>
                </svg>
            </button>
        </div>

        <!-- Text input -->
        <div class="flex gap-2 items-end">
            <button type="button"
                    class="btn btn-sm btn-square"
                    :class="listening ? 'btn-error' : 'btn-ghost'"
                    :disabled="!connected"
                    @click="toggleVoice()">
                <svg x-show="!listening"
                     class="w-4 h-4" fill="none"
                     stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2.5"
                          d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2.5"
                          d="M19 10v2a7 7 0 01-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"
                          stroke-linecap="round"
                          stroke-width="2.5"/>
                </svg>
                <svg x-show="listening"
                     class="w-4 h-4" viewBox="0 0 24 24"
                     fill="currentColor">
                    <rect x="6" y="6" width="12" height="12" rx="2"/>
                </svg>
            </button>
            <textarea x-model="inputText"
                      placeholder="Type a message or command..."
                      class="textarea textarea-bordered flex-1 resize-none leading-snug"
                      rows="1"
                      :disabled="!connected"
                      x-ref="messageInput"
                      @keydown.enter="if(!$event.shiftKey&&matchMedia('(hover:hover)').matches){$event.preventDefault();sendMessage()}"
                      style="max-height: 6lh"
                      @input="$el.style.height='auto';$el.style.height=$el.scrollHeight+'px'"></textarea>
            <button type="button"
                    class="btn btn-primary btn-sm btn-square"
                    :disabled="!connected || !inputText.trim() || uiState === 'working'"
                    @click="sendMessage()">
                <svg class="w-4 h-4" fill="none"
                     stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2.5"
                          d="M5 12h14m-7-7l7 7-7 7"/>
                </svg>
            </button>
        </div>
        <div x-show="!connected" class="text-warning text-xs mt-1">
            Disconnected - reconnecting...
        </div>
    </div>
    <!-- Debug modal -->
    <dialog class="modal" :class="{'modal-open': showDebugModal}">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-2">Report an issue</h3>
            <textarea x-model="debugDescription"
                      x-ref="debugInput"
                      class="textarea textarea-bordered w-full"
                      rows="5"
                      placeholder="What went wrong?"></textarea>
            <div class="modal-action">
                <button class="btn btn-ghost"
                        @click="showDebugModal = false">Cancel</button>
                <button class="btn btn-primary"
                        :disabled="!debugDescription.trim()"
                        @click="submitDebug()">Debug</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"
              @click="showDebugModal = false"></form>
    </dialog>
</div>
{% endblock %}
